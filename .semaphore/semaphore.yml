version: v1.0
name: React Next Base

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

execution_time_limit:
  minutes: 10

auto_cancel:
  running:
    when: 'true'

global_job_config:
  env_vars:
    - name: API_URL
      value: 'https://rails-base-graphql-api.herokuapp.com'

  secrets:
    - name: react-next-base-secrets

  prologue:
    commands:
      - checkout
      - nvm use
      - cache restore

blocks:
  - name: Setup
    task:
      jobs:
        - name: yarn install and cache
          commands:
            - yarn install --frozen-lockfile

            - cache store
            - cache store cypress-${SEMAPHORE_GIT_BRANCH}-$(checksum yarn.lock)-$(checksum .semaphore/semaphore.yml) ~/.cache/Cypress

  - name: Lints
    task:
      jobs:
        - name: Common
          commands:
            - yarn run lint

        - name: CSS
          commands:
            - yarn run lint:css

  - name: Tests
    task:
      jobs:
        - name: Yarn
          commands:
            - yarn run test:ci

        - name: Cypress
          commands:
            # restore cypress cache
            - cache restore cypress-${SEMAPHORE_GIT_BRANCH}-$(checksum yarn.lock)-$(checksum .semaphore/semaphore.yml)

            # verify the Cypress test binary so its check status is cached
            - yarn run cy:verify

            # setup cypress.env from secrets
            - cp ~/.config/cypress.env.json ./

            # prints SEMAPHORE_* environment variables
            - yarn run print-env -- SEMAPHORE

            # finally, build the web application and run end-to-end tests
            - yarn start:ci
            - yarn cy:run
