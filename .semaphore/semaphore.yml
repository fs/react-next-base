version: v1.0
name: React Next Base

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

execution_time_limit:
  minutes: 10

auto_cancel:
  running:
    when: 'true'

global_job_config:
  env_vars:
    - name: API_URL
      value: 'https://rails-base-graphql-api.herokuapp.com'

  secrets:
    - name: react-next-base-secrets

  prologue:
    commands:
      - checkout
      - cache restore node-modules-${SEMAPHORE_GIT_BRANCH}-$(checksum yarn.lock),node-modules-${SEMAPHORE_GIT_BRANCH},node-modules-master
      - nvm use

blocks:
  - name: Setup
    task:
      jobs:
        - name: yarn install and cache
          commands:
            - yarn
            - cache store node-modules-${SEMAPHORE_GIT_BRANCH}-$(checksum yarn.lock) node_modules

  - name: Lints
    task:
      jobs:
        - name: Common
          commands:
            - yarn run lint

        - name: CSS
          commands:
            - yarn run lint:css

  - name: Tests
    task:
      jobs:
        - name: Yarn
          commands:
            - yarn run test:ci

        - name: Cypress
          commands:
            - yarn add cypress --save-dev
            - yarn build
            - 'yarn start:ci &'
            - 'yarn cy:run'
